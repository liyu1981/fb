"use strict";var pdf2htmlEX=window["pdf2htmlEX"]=window["pdf2htmlEX"]||{};var CSS_CLASS_NAMES={page_frame:"pf",page_content_box:"pc",page_data:"pi",background_image:"bi",link:"l",__dummy__:"no comma"};var DEFAULT_CONFIG={container_id:"page-container",sidebar_id:"sidebar",outline_id:"outline",loading_indicator_cls:"loading-indicator",preload_pages:3,render_timeout:100,scale_step:.9,key_handler:true,hashchange_handler:true,__dummy__:"no comma"};var EPS=1e-6;function invert(ctm){var det=ctm[0]*ctm[3]-ctm[1]*ctm[2];return[ctm[3]/det,-ctm[1]/det,-ctm[2]/det,ctm[0]/det,(ctm[2]*ctm[5]-ctm[3]*ctm[4])/det,(ctm[1]*ctm[4]-ctm[0]*ctm[5])/det]}function transform(ctm,pos){return[ctm[0]*pos[0]+ctm[2]*pos[1]+ctm[4],ctm[1]*pos[0]+ctm[3]*pos[1]+ctm[5]]}function get_page_number(ele){return parseInt(ele.getAttribute("data-page-no"),16)}function disable_dragstart(eles){for(var i=0,l=eles.length;i<l;++i){eles[i].addEventListener("dragstart",function(){return false},false)}}function clone_and_extend_objs(var_args){var result_obj={};for(var i=0,l=arguments.length;i<l;++i){var cur_obj=arguments[i];for(var k in cur_obj){if(cur_obj.hasOwnProperty(k)){result_obj[k]=cur_obj[k]}}}return result_obj}function Page(page){if(!page)return;this.loaded=false;this.shown=false;this.page=page;this.num=get_page_number(page);this.original_height=page.clientHeight;this.original_width=page.clientWidth;var content_box=page.getElementsByClassName(CSS_CLASS_NAMES.page_content_box)[0];if(content_box){this.content_box=content_box;this.original_scale=this.cur_scale=this.original_height/content_box.clientHeight;this.page_data=JSON.parse(page.getElementsByClassName(CSS_CLASS_NAMES.page_data)[0].getAttribute("data-data"));this.ctm=this.page_data["ctm"];this.ictm=invert(this.ctm);this.loaded=true}}Page.prototype={hide:function(){if(this.loaded&&this.shown){this.content_box.classList.remove("opened");this.shown=false}},show:function(){if(this.loaded&&!this.shown){this.content_box.classList.add("opened");this.shown=true}},rescale:function(ratio){if(ratio===0){this.cur_scale=this.original_scale}else{this.cur_scale=ratio}if(this.loaded){var cbs=this.content_box.style;cbs.msTransform=cbs.webkitTransform=cbs.transform="scale("+this.cur_scale.toFixed(3)+")"}{var ps=this.page.style;ps.height=this.original_height*this.cur_scale+"px";ps.width=this.original_width*this.cur_scale+"px"}},view_position:function(){var p=this.page;var c=p.parentNode;return[c.scrollLeft-p.offsetLeft-p.clientLeft,c.scrollTop-p.offsetTop-p.clientTop]},height:function(){return this.page.clientHeight},width:function(){return this.page.clientWidth}};function Viewer(config){this.config=clone_and_extend_objs(DEFAULT_CONFIG,arguments.length>0?config:{});this.pages_loading=[];this.init_before_loading_content();var self=this;document.addEventListener("DOMContentLoaded",function(){self.init_after_loading_content()},false)}Viewer.prototype={scale:1,cur_page_idx:0,first_page_idx:0,init_before_loading_content:function(){this.pre_hide_pages()},init_after_loading_content:function(){this.sidebar=document.getElementById(this.config["sidebar_id"]);this.outline=document.getElementById(this.config["outline_id"]);this.container=document.getElementById(this.config["container_id"]);this.loading_indicator=document.getElementsByClassName(this.config["loading_indicator_cls"])[0];{var empty=true;var nodes=this.outline.childNodes;for(var i=0,l=nodes.length;i<l;++i){var cur_node=nodes[i];if(cur_node.nodeName.toLowerCase()==="ul"){empty=false;break}}if(!empty)this.sidebar.classList.add("opened")}this.find_pages();if(this.pages.length==0)return;disable_dragstart(document.getElementsByClassName(CSS_CLASS_NAMES.background_image));if(this.config["key_handler"])this.register_key_handler();var self=this;if(this.config["hashchange_handler"]){window.addEventListener("hashchange",function(e){self.navigate_to_dest(document.location.hash.substring(1))},false)}this.container.addEventListener("scroll",function(){self.update_page_idx();self.schedule_render(true)},false);[this.container,this.outline].forEach(function(ele){ele.addEventListener("click",self.link_handler.bind(self),false)});this.render()},find_pages:function(){var new_pages=[];var new_page_map={};var nodes=this.container.childNodes;for(var i=0,l=nodes.length;i<l;++i){var cur_node=nodes[i];if(cur_node.nodeType===Node.ELEMENT_NODE&&cur_node.classList.contains(CSS_CLASS_NAMES.page_frame)){var p=new Page(cur_node);new_pages.push(p);new_page_map[p.num]=new_pages.length-1}}this.pages=new_pages;this.page_map=new_page_map},load_page:function(idx,pages_to_preload,callback){var pages=this.pages;if(idx>=pages.length)return;var cur_page=pages[idx];if(cur_page.loaded)return;if(this.pages_loading[idx])return;var cur_page_ele=cur_page.page;var url=cur_page_ele.getAttribute("data-page-url");if(url){this.pages_loading[idx]=true;var new_loading_indicator=this.loading_indicator.cloneNode();new_loading_indicator.classList.add("active");cur_page_ele.appendChild(new_loading_indicator);{var self=this;var _idx=idx;var xhr=new XMLHttpRequest;xhr.open("GET",url,true);xhr.onload=function(){if(xhr.status===200||xhr.status===0){var div=document.createElement("div");div.innerHTML=xhr.responseText;var new_page=null;var nodes=div.childNodes;for(var i=0,l=nodes.length;i<l;++i){var cur_node=nodes[i];if(cur_node.nodeType===Node.ELEMENT_NODE&&cur_node.classList.contains(CSS_CLASS_NAMES.page_frame)){new_page=cur_node;break}}var p=self.pages[_idx];self.container.replaceChild(new_page,p.page);p=new Page(new_page);self.pages[_idx]=p;p.hide();p.rescale(self.scale);disable_dragstart(new_page.getElementsByClassName(CSS_CLASS_NAMES.background_image));self.schedule_render(false);if(callback){callback(p)}}delete self.pages_loading[_idx]};xhr.send(null)}}if(pages_to_preload===undefined)pages_to_preload=this.config["preload_pages"];if(--pages_to_preload>0){var self=this;setTimeout(function(){self.load_page(idx+1,pages_to_preload)},0)}},pre_hide_pages:function(){var s="@media screen{."+CSS_CLASS_NAMES.page_content_box+"{display:none;}}";var n=document.createElement("style");if(n.styleSheet){n.styleSheet.cssText=s}else{n.appendChild(document.createTextNode(s))}document.head.appendChild(n)},render:function(){var container=this.container;var container_min_y=container.scrollTop;var container_height=container.clientHeight;var container_max_y=container_min_y+container_height;var visible_min_y=container_min_y-container_height;var visible_max_y=container_max_y+container_height;var cur_page_fully_visible=false;var cur_page_idx=this.cur_page_idx;var max_visible_page_idx=cur_page_idx;var max_visible_ratio=0;var pl=this.pages;for(var i=0,l=pl.length;i<l;++i){var cur_page=pl[i];var cur_page_ele=cur_page.page;var page_min_y=cur_page_ele.offsetTop+cur_page_ele.clientTop;var page_height=cur_page_ele.clientHeight;var page_max_y=page_min_y+page_height;if(page_min_y<=visible_max_y&&page_max_y>=visible_min_y){if(cur_page.loaded){cur_page.show()}else{this.load_page(i)}}else{cur_page.hide()}}},update_page_idx:function(){var pages=this.pages;var pages_len=pages.length;if(pages_len<2)return;var container=this.container;var container_min_y=container.scrollTop;var container_max_y=container_min_y+container.clientHeight;var first_idx=-1;var last_idx=pages_len;var rest_len=last_idx-first_idx;while(rest_len>1){var idx=first_idx+Math.floor(rest_len/2);var cur_page_ele=pages[idx].page;if(cur_page_ele.offsetTop+cur_page_ele.clientTop+cur_page_ele.clientHeight>=container_min_y){last_idx=idx}else{first_idx=idx}rest_len=last_idx-first_idx}this.first_page_idx=last_idx;var cur_page_idx=this.cur_page_idx;var max_visible_page_idx=cur_page_idx;var max_visible_ratio=0;for(var i=last_idx;i<pages_len;++i){var cur_page_ele=pages[i].page;var page_min_y=cur_page_ele.offsetTop+cur_page_ele.clientTop;var page_height=cur_page_ele.clientHeight;var page_max_y=page_min_y+page_height;if(page_min_y>container_max_y)break;var page_visible_ratio=(Math.min(container_max_y,page_max_y)-Math.max(container_min_y,page_min_y))/page_height;if(i===cur_page_idx&&Math.abs(page_visible_ratio-1)<=EPS){max_visible_page_idx=cur_page_idx;break}if(page_visible_ratio>max_visible_ratio){max_visible_ratio=page_visible_ratio;max_visible_page_idx=i}}this.cur_page_idx=max_visible_page_idx},schedule_render:function(renew){if(this.render_timer!==undefined){if(!renew)return;clearTimeout(this.render_timer)}var self=this;this.render_timer=setTimeout(function(){delete self.render_timer;self.render()},this.config["render_timeout"])},register_key_handler:function(){var self=this;window.addEventListener("DOMMouseScroll",function(e){if(e.ctrlKey){e.preventDefault();var container=self.container;var rect=container.getBoundingClientRect();var fixed_point=[e.clientX-rect["left"]-container.clientLeft,e.clientY-rect["top"]-container.clientTop];self.rescale(Math.pow(self.config["scale_step"],e.detail),true,fixed_point)}},false);window.addEventListener("keydown",function(e){var handled=false;var with_ctrl=e.ctrlKey||e.metaKey;var with_alt=e.altKey;switch(e.keyCode){case 61:case 107:case 187:if(with_ctrl){self.rescale(1/self.config["scale_step"],true);handled=true}break;case 173:case 109:case 189:if(with_ctrl){self.rescale(self.config["scale_step"],true);handled=true}break;case 48:if(with_ctrl){self.rescale(0,false);handled=true}break;case 33:if(with_alt){self.scroll_to(self.cur_page_idx-1)}else{self.container.scrollTop-=self.container.clientHeight}handled=true;break;case 34:if(with_alt){self.scroll_to(self.cur_page_idx+1)}else{self.container.scrollTop+=self.container.clientHeight}handled=true;break;case 35:self.container.scrollTop=self.container.scrollHeight;handled=true;break;case 36:self.container.scrollTop=0;handled=true;break}if(handled){e.preventDefault();return}},false)},rescale:function(ratio,is_relative,fixed_point){var old_scale=this.scale;var new_scale=old_scale;if(ratio===0){new_scale=1;is_relative=false}else if(is_relative)new_scale*=ratio;else new_scale=ratio;this.scale=new_scale;if(!fixed_point)fixed_point=[0,0];var container=this.container;fixed_point[0]+=container.scrollLeft;fixed_point[1]+=container.scrollTop;var pl=this.pages;var pl_len=pl.length;for(var i=this.first_page_idx;i<pl_len;++i){var p=pl[i].page;if(p.offsetTop+p.clientTop>=fixed_point[1])break}var fixed_point_page_idx=i-1;if(fixed_point_page_idx<0)fixed_point_page_idx=0;var fp_p=pl[fixed_point_page_idx].page;var fp_p_width=fp_p.clientWidth;var fp_p_height=fp_p.clientHeight;var fp_x_ref=fp_p.offsetLeft+fp_p.clientLeft;var fp_x_inside=fixed_point[0]-fp_x_ref;if(fp_x_inside<0)fp_x_inside=0;else if(fp_x_inside>fp_p_width)fp_x_inside=fp_p_width;var fp_y_ref=fp_p.offsetTop+fp_p.clientTop;var fp_y_inside=fixed_point[1]-fp_y_ref;if(fp_y_inside<0)fp_y_inside=0;else if(fp_y_inside>fp_p_height)fp_y_inside=fp_p_height;for(var i=0;i<pl_len;++i)pl[i].rescale(new_scale);container.scrollLeft+=fp_x_inside/old_scale*new_scale+fp_p.offsetLeft+fp_p.clientLeft-fp_x_inside-fp_x_ref;container.scrollTop+=fp_y_inside/old_scale*new_scale+fp_p.offsetTop+fp_p.clientTop-fp_y_inside-fp_y_ref;this.schedule_render(true)},fit_width:function(){var page_idx=this.cur_page_idx;this.rescale(this.container.clientWidth/this.pages[page_idx].width(),false);this.scroll_to(page_idx)},fit_height:function(){var page_idx=this.cur_page_idx;this.rescale(this.container.clientHeight/this.pages[page_idx].height(),false);this.scroll_to(page_idx)},get_containing_page:function(ele){while(ele){if(ele.nodeType===Node.ELEMENT_NODE&&ele.classList.contains(CSS_CLASS_NAMES.page_frame)){var pn=get_page_number(ele);var pm=this.page_map;return pn in pm?this.pages[pm[pn]]:null}ele=ele.parentNode}return null},link_handler:function(e){var target=e.target;var detail_str=target.getAttribute("data-dest-detail");if(!detail_str)return;this.navigate_to_dest(detail_str,this.get_containing_page(target));e.preventDefault()},navigate_to_dest:function(detail_str,src_page){try{var detail=JSON.parse(detail_str)}catch(e){return}if(!(detail instanceof Array))return;var target_page_no=detail[0];var page_map=this.page_map;if(!(target_page_no in page_map))return;var target_page_idx=page_map[target_page_no];var target_page=this.pages[target_page_idx];for(var i=2,l=detail.length;i<l;++i){var d=detail[i];if(!(d===null||typeof d==="number"))return}while(detail.length<6)detail.push(null);var cur_page=src_page||this.pages[this.cur_page_idx];var cur_pos=cur_page.view_position();cur_pos=transform(cur_page.ictm,[cur_pos[0],cur_page.height()-cur_pos[1]]);var zoom=this.scale;var pos=[0,0];var upside_down=true;var ok=false;var scale=this.scale;switch(detail[1]){case"XYZ":pos=[detail[2]===null?cur_pos[0]:detail[2]*scale,detail[3]===null?cur_pos[1]:detail[3]*scale];zoom=detail[4];if(zoom===null||zoom===0)zoom=this.scale;ok=true;break;case"Fit":case"FitB":pos=[0,0];ok=true;break;case"FitH":case"FitBH":pos=[0,detail[2]===null?cur_pos[1]:detail[2]*scale];ok=true;break;case"FitV":case"FitBV":pos=[detail[2]===null?cur_pos[0]:detail[2]*scale,0];ok=true;break;case"FitR":pos=[detail[2]*scale,detail[5]*scale];upside_down=false;ok=true;break;default:break}if(!ok)return;this.rescale(zoom,false);var self=this;var transform_and_scroll=function(page){pos=transform(page.ctm,pos);if(upside_down){pos[1]=page.height()-pos[1]}self.scroll_to(target_page_idx,pos)};if(target_page.loaded){transform_and_scroll(target_page)}else{this.load_page(target_page_idx,undefined,transform_and_scroll);this.scroll_to(target_page_idx)}},scroll_to:function(page_idx,pos){var pl=this.pages;if(page_idx<0||page_idx>=pl.length)return;var target_page=pl[page_idx];var cur_target_pos=target_page.view_position();if(pos===undefined)pos=[0,0];var container=this.container;container.scrollLeft+=pos[0]-cur_target_pos[0];container.scrollTop+=pos[1]-cur_target_pos[1]}};pdf2htmlEX["Viewer"]=Viewer;